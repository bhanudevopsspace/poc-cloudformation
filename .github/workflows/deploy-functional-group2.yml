name: Deploy Functional Group 2

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'cloudformation/layers/functional-group2.yaml'
      - 'cloudformation/modules/lambda.yaml'
      - 'cloudformation/modules/api-gateway.yaml'
      - 'cloudformation/modules/s3-bucket.yaml'
      - 'cloudformation/modules/kms-key.yaml'
      - 'lambda/**'
      - '.github/workflows/deploy-functional-group2.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'cloudformation/layers/functional-group2.yaml'
      - 'cloudformation/modules/lambda.yaml'
      - 'cloudformation/modules/api-gateway.yaml'
      - 'cloudformation/modules/s3-bucket.yaml'
      - 'cloudformation/modules/kms-key.yaml'
      - 'lambda/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AWS_REGION_DEV: us-west-1
  AWS_REGION_STAGING: us-west-2
  AWS_REGION_PROD: us-east-1

jobs:
  prepare:
    name: Prepare Deployment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      region: ${{ steps.set-env.outputs.region }}
      s3-bucket: ${{ steps.set-env.outputs.s3-bucket }}
    
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="staging"
          else
            ENV="dev"
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          
          # Set region based on environment
          if [ "$ENV" == "dev" ]; then
            echo "region=${{ env.AWS_REGION_DEV }}" >> $GITHUB_OUTPUT
            echo "s3-bucket=cfn-artifacts-us-west-1" >> $GITHUB_OUTPUT
          elif [ "$ENV" == "staging" ]; then
            echo "region=${{ env.AWS_REGION_STAGING }}" >> $GITHUB_OUTPUT
            echo "s3-bucket=cumulus-cfn-artifacts-us-west-2" >> $GITHUB_OUTPUT
          else
            echo "region=${{ env.AWS_REGION_PROD }}" >> $GITHUB_OUTPUT
            echo "s3-bucket=cfn-artifacts-us-east-1" >> $GITHUB_OUTPUT
          fi

  build-lambda:
    name: Build and Upload Lambda Code
    runs-on: ubuntu-latest
    needs: prepare
    environment:
      name: ${{ needs.prepare.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ needs.prepare.outputs.region }}
      
      - name: Package Lambda Function
        run: |
          cd lambda
          zip -r lambda-code.zip index.py
          ls -lh lambda-code.zip
      
      - name: Upload Lambda to S3
        run: |
          aws s3 cp lambda/lambda-code.zip s3://${{ needs.prepare.outputs.s3-bucket }}/lambda-code.zip
          echo "‚úÖ Lambda code uploaded to s3://${{ needs.prepare.outputs.s3-bucket }}/lambda-code.zip"

  get-common-layer-outputs:
    name: Get Common Layer Outputs
    runs-on: ubuntu-latest
    needs: prepare
    environment:
      name: ${{ needs.prepare.outputs.environment }}
    outputs:
      lambda-role-arn: ${{ steps.outputs.outputs.lambda-role-arn }}
      ssm-parameter: ${{ steps.outputs.outputs.ssm-parameter }}
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ needs.prepare.outputs.region }}
      
      - name: Get Common Layer Stack Outputs
        id: outputs
        run: |
          STACK_NAME="cumulus-${{ needs.prepare.outputs.environment }}-common-layer"
          
          echo "Checking for Common Layer stack: $STACK_NAME"
          
          if ! aws cloudformation describe-stacks --stack-name $STACK_NAME --region ${{ needs.prepare.outputs.region }} 2>/dev/null; then
            echo "‚ùå Common Layer stack not found: $STACK_NAME"
            echo "Please deploy the common layer first using the deploy-common-layer workflow"
            exit 1
          fi
          
          ROLE_ARN=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region ${{ needs.prepare.outputs.region }} \
            --query 'Stacks[0].Outputs[?OutputKey==`LambdaRoleArn`].OutputValue' \
            --output text)
          
          SSM_PARAM=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region ${{ needs.prepare.outputs.region }} \
            --query 'Stacks[0].Outputs[?OutputKey==`SSMParameterName`].OutputValue' \
            --output text)
          
          echo "lambda-role-arn=$ROLE_ARN" >> $GITHUB_OUTPUT
          echo "ssm-parameter=$SSM_PARAM" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Lambda Role ARN: $ROLE_ARN"
          echo "‚úÖ SSM Parameter: $SSM_PARAM"

  deploy-functional-group2:
    name: Deploy Functional Group 2
    runs-on: ubuntu-latest
    needs: [prepare, build-lambda, get-common-layer-outputs]
    environment:
      name: ${{ needs.prepare.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ needs.prepare.outputs.region }}
      
      - name: Verify AWS Connection
        run: |
          echo "Testing AWS connection..."
          aws sts get-caller-identity
          echo "Current region: ${{ needs.prepare.outputs.region }}"
      
      - name: Package Functional Group 2 Template
        run: |
          cd cloudformation/layers
          
          aws cloudformation package \
            --region ${{ needs.prepare.outputs.region }} \
            --template-file functional-group2.yaml \
            --s3-bucket ${{ needs.prepare.outputs.s3-bucket }} \
            --output-template-file packaged-functional-group2-${{ needs.prepare.outputs.environment }}.yaml
      
      - name: Deploy Functional Group 2 Stack
        run: |
          cd cloudformation/layers
          
          aws cloudformation deploy \
            --region ${{ needs.prepare.outputs.region }} \
            --template-file packaged-functional-group2-${{ needs.prepare.outputs.environment }}.yaml \
            --stack-name cumulus-${{ needs.prepare.outputs.environment }}-functional-group2 \
            --parameter-overrides \
              Environment=${{ needs.prepare.outputs.environment }} \
              ApplicationName=cumulus \
              LambdaCodeBucket=${{ needs.prepare.outputs.s3-bucket }} \
              LambdaCodeKey=lambda-code.zip \
              LambdaRoleArn=${{ needs.get-common-layer-outputs.outputs.lambda-role-arn }} \
              SSMParameterName=${{ needs.get-common-layer-outputs.outputs.ssm-parameter }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
      
      - name: Get Stack Outputs
        run: |
          echo "üìã Functional Group 2 Stack Outputs:"
          aws cloudformation describe-stacks \
            --region ${{ needs.prepare.outputs.region }} \
            --stack-name cumulus-${{ needs.prepare.outputs.environment }}-functional-group2 \
            --query 'Stacks[0].Outputs' \
            --output table

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [prepare, deploy-functional-group2]
    if: always()
    
    steps:
      - name: Deployment Success
        if: needs.deploy-functional-group2.result == 'success'
        run: |
          echo "‚úÖ Functional Group 2 deployment to ${{ needs.prepare.outputs.environment }} completed successfully!"
          echo "Region: ${{ needs.prepare.outputs.region }}"
          echo "Stack: cumulus-${{ needs.prepare.outputs.environment }}-functional-group2"
      
      - name: Deployment Failed
        if: needs.deploy-functional-group2.result != 'success'
        run: |
          echo "‚ùå Functional Group 2 deployment to ${{ needs.prepare.outputs.environment }} failed!"
          exit 1
