# Change Detection Configuration
# Maps file patterns to resource types, impact levels, target layers, and required actions
# NOW ORGANIZED BY FUNCTION-BASED LAYERS (not domain stacks)

exclusions:
  patterns:
    - "**/*.gradle"
    - "**/*.jar"
    - "**/.gradle/**"
    - "**/.idea/**"
    - "**/build/**"
    - "**/target/**"
    - "**/.git/**"
    - "**/cloudformation/**"  # Don't re-detect CF templates as code changes
    - "**/README.md"
    - "**/.gitignore"
    - "**/node_modules/**"
    - "**/__pycache__/**"
    - "**/*.pyc"
  description: "Build artifacts, IDE files, tests, and CloudFormation templates themselves"

resourceMappings:
  # ========================================
  # VPC LAYER (Foundation - Networking)
  # ========================================
  vpc_layer:
    patterns:
      - "cloudformation/layers/vpc-layer.yaml"
      - "infrastructure/network/**"
      - "config/**/network*.json"
      - "config/**/vpc*.json"
    resource_type: "AWS::EC2::VPC"
    impact_level: "CRITICAL"
    target_stack: "vpc_layer"
    affected_child_stacks:
      - "VPC"
      - "Subnets"
      - "InternetGateway"
      - "NatGateway"
    required_actions:
      - "update"
    description: "VPC layer changes - affects networking foundation"

  # ========================================
  # LAMBDA LAYER (Functions + IAM)
  # ========================================
  lambda_layer_template:
    patterns:
      - "cloudformation/layers/lambda-layer.yaml"
    resource_type: "AWS::Lambda::Function"
    impact_level: "HIGH"
    target_stack: "lambda_layer"
    affected_child_stacks:
      - "LambdaFunction"
      - "LambdaExecutionRole"
      - "LambdaExecutionPolicy"
    required_actions:
      - "update"
    description: "Lambda layer template changes"

  lambda_code:
    patterns:
      - "lambda-*/src/**"
      - "lambda-*/**/*.py"
      - "lambda-*/**/*.java"
      - "lambda-*/**/*.js"
      - "lambda-*/**/*.ts"
      - "src/lambda/**"
      - "functions/**"
    resource_type: "AWS::Lambda::Function"
    impact_level: "HIGH"
    target_stack: "lambda_layer"
    affected_child_stacks:
      - "LambdaFunction"
    required_actions:
      - "build"
      - "package"
      - "upload"
      - "update"
    description: "Lambda function code changes"

  # ========================================
  # S3 LAYER (Buckets + IAM)
  # ========================================
  s3_layer_template:
    patterns:
      - "cloudformation/layers/s3-layer.yaml"
    resource_type: "AWS::S3::Bucket"
    impact_level: "HIGH"
    target_stack: "s3_layer"
    affected_child_stacks:
      - "S3Bucket"
      - "S3AccessRole"
      - "S3AccessPolicy"
    required_actions:
      - "update"
    description: "S3 layer template changes"

  s3_config:
    patterns:
      - "config/**/s3*.json"
      - "config/**/bucket*.json"
    resource_type: "AWS::S3::Bucket"
    impact_level: "MEDIUM"
    target_stack: "s3_layer"
    affected_child_stacks:
      - "S3Bucket"
    required_actions:
      - "update"
    description: "S3 bucket configuration changes"

  # ========================================
  # EC2 LAYER (Instances + IAM)
  # ========================================
  ec2_layer_template:
    patterns:
      - "cloudformation/layers/ec2-layer.yaml"
    resource_type: "AWS::EC2::Instance"
    impact_level: "HIGH"
    target_stack: "ec2_layer"
    affected_child_stacks:
      - "EC2Instance"
      - "EC2InstanceRole"
      - "EC2AccessPolicy"
      - "EC2SecurityGroup"
    required_actions:
      - "update"
    description: "EC2 layer template changes"

  ec2_code:
    patterns:
      - "modules/ec2/**"
      - "src/ec2/**"
      - "config/**/ec2*.json"
    resource_type: "AWS::EC2::Instance"
    impact_level: "HIGH"
    target_stack: "ec2_layer"
    affected_child_stacks:
      - "EC2Instance"
    required_actions:
      - "build"
      - "update"
    description: "EC2 instance configuration and code"

  # ========================================
  # ROOT APPLICATION TEMPLATES
  # ========================================
  application_root:
    patterns:
      - "cloudformation/applications/*/root.yaml"
      - "cloudformation/applications/*/app.yaml"
    resource_type: "AWS::CloudFormation::Stack"
    impact_level: "HIGH"
    target_stack: "application"
    affected_child_stacks: []
    required_actions:
      - "update"
    description: "Application root template changes"

  # ========================================
  # UTILITY LIBRARIES (CRITICAL - triggers all layers)
  # ========================================
  utility_libraries:
    patterns:
      - "lib/**"
      - "shared/**"
      - "common/**"
      - "utils/**"
      - "src/main/java/com/example/util/**"
      - "src/main/java/com/example/common/**"
    resource_type: "LIBRARY"
    impact_level: "CRITICAL"
    target_stack: "all"
    affected_child_stacks:
      - "Lambda"
      - "EC2"
    required_actions:
      - "build"
      - "rebuild_dependents"
    description: "Shared utility libraries - changes force rebuild of all dependent layers"

  # ========================================
  # CONFIGURATION FILES
  # ========================================
  app_config:
    patterns:
      - "config/**/*.json"
      - "config/**/*.yaml"
      - "config/**/*.yml"
    resource_type: "CONFIG"
    impact_level: "MEDIUM"
    target_stack: "application"
    affected_child_stacks: []
    required_actions:
      - "update_config"
    description: "Application configuration files"

# ========================================
# DEPLOYMENT CHECKLIST (Layer-based)
# ========================================
deploymentChecklist:
  vpc_layer:
    description: "VPC, subnets, internet gateway, NAT gateway"
    stacks:
      - "VPC"
      - "InternetGateway"
      - "NatGateway"
  
  lambda_layer:
    description: "Lambda functions with their IAM roles and policies"
    stacks:
      - "LambdaFunction"
      - "LambdaExecutionRole"
      - "LambdaExecutionPolicy"
  
  s3_layer:
    description: "S3 buckets with their IAM roles and policies"
    stacks:
      - "S3Bucket"
      - "S3AccessRole"
      - "S3AccessPolicy"
  
  ec2_layer:
    description: "EC2 instances with their IAM roles, policies, and security groups"
    stacks:
      - "EC2Instance"
      - "EC2InstanceRole"
      - "EC2AccessPolicy"
      - "EC2SecurityGroup"
  
  application:
    description: "Application-level configuration and root templates"
    stacks: []

# ========================================
# CLOUDFORMATION CONDITION MAPPING
# ========================================
cloudFormationConditionMapping:
  vpc_layer: "DeployVpcLayer"
  lambda_layer: "DeployLambdaLayer"
  s3_layer: "DeployS3Layer"
  ec2_layer: "DeployEc2Layer"
  application: "DeployApplicationStack"
